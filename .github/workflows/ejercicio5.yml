name: Ejercicio 5 - Workflow Completo

on:
  push:
    branches: [main, feature/*]
  pull_request:
    branches: [main]

# Variables de entorno globales
env:
  APP_NAME: "Quiz App"
  VERSION: "1.0.0"

jobs:
  setup:
    name: Configuración inicial
    runs-on: ubuntu-latest
    
    outputs:
      timestamp: ${{ steps.create-timestamp.outputs.timestamp }}
    
    steps:
      - name: Imprimir información de la aplicación
        run: |
          echo "Nombre de la aplicación: $APP_NAME"
          echo "Versión: $VERSION"
      
      - name: Crear timestamp
        id: create-timestamp
        run: |
          echo "timestamp=$(date +%s)" >> $GITHUB_OUTPUT

  test:
    name: Ejecutar tests
    runs-on: ubuntu-latest
    needs: setup
    
    # Variable de entorno específica del job
    env:
      NODE_ENV: test
    
    steps:
      - name: Checkout del código
        uses: actions/checkout@v4
      
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Imprimir timestamp del job anterior
        run: |
          echo "Timestamp del job setup: ${{ needs.setup.outputs.timestamp }}"
      
      - name: Instalar dependencias
        run: |
          npm ci
        continue-on-error: true
      
      - name: Ejecutar tests
        run: |
          echo "Ejecutando tests en entorno: $NODE_ENV"
          # Comando de ejemplo para tests
          # npm test
          echo "Tests completados exitosamente"

  deploy:
    name: Despliegue
    runs-on: ubuntu-latest
    needs: test
   
    if: github.ref == 'refs/heads/main'
    
    
    env:
      API_KEY: ${{ secrets.API_KEY }}
    
    steps:
      - name: Imprimir información del despliegue
        run: |
          echo "Desplegando ${{ env.APP_NAME }} v${{ env.VERSION }}"
      
      - name: Verificar secret configurado
        run: |
          if [ -n "$API_KEY" ]; then
            echo "Secret configurada correctamente"
          else
            echo "ERROR: Secret no configurada"
            exit 1
          fi
      
      - name: Simular despliegue
        run: |
          echo "Iniciando proceso de despliegue..."
          # Aquí irían los comandos reales de despliegue
          # Por ejemplo: npm run deploy, serverless deploy, etc.
          echo "Despliegue simulado completado"
