name: Ejercicio 5 - Workflow Completo

on:
  push:
    branches: [main, feature/*]
  pull_request:
    branches: [main]

# Variables de entorno globales
env:
  APP_NAME: "Quiz App"
  VERSION: "1.0.0"

jobs:
  setup:
    name: ConfiguraciÃ³n inicial
    runs-on: ubuntu-latest
    
    outputs:
      timestamp: ${{ steps.create-timestamp.outputs.timestamp }}
    
    steps:
      - name: Imprimir informaciÃ³n de la aplicaciÃ³n
        run: |
          echo "Nombre de la aplicaciÃ³n: $APP_NAME"
          echo "VersiÃ³n: $VERSION"
      
      - name: Crear timestamp
        id: create-timestamp
        run: |
          echo "timestamp=$(date +%s)" >> $GITHUB_OUTPUT

  test:
    name: Ejecutar tests
    runs-on: ubuntu-latest
    needs: setup
    
    # Variable de entorno especÃ­fica del job
    env:
      NODE_ENV: test
    
    steps:
      - name: Checkout del cÃ³digo
        uses: actions/checkout@v4
      
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
        
      
      - name: Imprimir timestamp del job anterior
        run: |
          echo "Timestamp del job setup: ${{ needs.setup.outputs.timestamp }}"
      
      - name: Crear package.json simulado (para evitar errores)
        run: |
          # Crea un package.json bÃ¡sico si no existe
          if [ ! -f "package.json" ]; then
            echo '{
              "name": "quiz-app",
              "version": "1.0.0",
              "description": "AplicaciÃ³n de quiz",
              "scripts": {
                "test": "echo \"Tests ejecutados exitosamente\" && exit 0"
              }
            }' > package.json
            echo "âœ… Created package.json for testing purposes"
          fi
      
      - name: Ejecutar tests simulados
        run: |
          echo "Ejecutando tests en entorno: $NODE_ENV"
          echo "Tests completados exitosamente"
          # Simulamos la ejecuciÃ³n de tests
          echo "âœ“ Todos los tests pasaron"

  deploy:
    name: Despliegue
    runs-on: ubuntu-latest
    needs: test
  
    if: github.ref == 'refs/heads/main'
    
    # Variable de entorno con secret
    env:
      API_KEY: ${{ secrets.API_KEY }}
    
    steps:
      - name: Imprimir informaciÃ³n del despliegue
        run: |
          echo "Desplegando ${{ env.APP_NAME }} v${{ env.VERSION }}"
      
      - name: Verificar secret configurado
        run: |
          if [ -n "$API_KEY" ]; then
            echo "âœ… Secret configurada correctamente"
          else
            echo "âŒ ERROR: Secret no configurada"
            exit 1
          fi
      
      - name: Simular despliegue
        run: |
          echo "ğŸš€ Iniciando proceso de despliegue..."
          echo "ğŸ“¦ Empaquetando aplicaciÃ³n..."
          echo "â˜ï¸  Subiendo a servidor..."
          echo "âœ… Despliegue simulado completado"
